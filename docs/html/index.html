<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PotteryOven Kiln Controller: CLAUDE.md</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">PotteryOven Kiln Controller<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">STM32F030C8 pottery kiln controller with PID temperature control</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="CLAUDE_8md.html">CLAUDE.md</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_CLAUDE"></a></p>
<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md1"></a>
Project Overview</h1>
<p>This is a <b>pottery kiln/oven controller</b> built on STM32F030C8 using STM32CubeIDE. The system controls heating coils via PID, reads thermocouple temperature via MAX31855, and provides a menu-driven UI via LCD and rotary encoder.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md2"></a>
Build Commands</h1>
<p>This is an STM32CubeIDE project. Build via the IDE:</p><ul>
<li><b>Import</b>: File &gt; Import &gt; Existing Projects into Workspace</li>
<li><b>Build</b>: Project &gt; Build Project (or Ctrl+B)</li>
<li><b>Clean</b>: Project &gt; Clean</li>
<li><b>Debug</b>: Run &gt; Debug (requires ST-Link)</li>
</ul>
<p>The project uses the HAL library and CMSIS-DSP (<span class="tt">arm_math.h</span> for <span class="tt">float32_t</span>, <span class="tt">arm_mean_f32</span>, etc.).</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md3"></a>
Architecture</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md4"></a>
Main Loop &amp; Initialization (<span class="tt">main.c</span>)</h2>
<p>Entry point initializes all peripherals and modules in order:</p><ol type="1">
<li>HAL and clocks</li>
<li>GPIO, I2C1, SPI2, USART1, RTC, TIM3</li>
<li>Application modules: log, MAX31855, heater, LCD, UI, encoder, event queue</li>
</ol>
<p>The main loop is currently a test sequence. Real operation happens through interrupts.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md5"></a>
Interrupt-Driven Design</h2>
<ul>
<li><b>RTC Alarm A</b> (every ~2 seconds): Triggers <span class="tt"><a class="el" href="heater_8c.html#ac2883f1108f7c28edb2c028a9e0f2639" title="RTC interrupt handler for temperature sampling and PID calculation.">heater_on_interupt()</a></span> for temperature sampling and PID calculations</li>
<li><b>TIM3 Input Capture</b>: Encoder rotation detection via <span class="tt"><a class="el" href="main_8c.html#a77a2401a35ddd9bd0b8fc28331b81381">HAL_TIM_IC_CaptureCallback()</a></span></li>
<li><b>GPIO EXTI</b>: Button presses (BUT1-5), encoder pins, door switch (SW_C) via <span class="tt"><a class="el" href="main_8c.html#a0cd91fd3a9608559c2a87a8ba6cba55f">HAL_GPIO_EXTI_Callback()</a></span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md6"></a>
Module Dependency Graph</h2>
<div class="fragment"><div class="line">main.c</div>
<div class="line">├── heater.c ──► MAX31855.c (temperature reading via SPI)</div>
<div class="line">│              └► pid.c (PID control logic)</div>
<div class="line">├── ui.c ──────► lcd1602_rgb.c (16x2 RGB LCD via I2C)</div>
<div class="line">│              └► event.c (event queue)</div>
<div class="line">├── encoder.c ─► event.c</div>
<div class="line">└── log.c (UART debug output, printf redirection)</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md7"></a>
Key Data Flow</h2>
<p><b>Temperature Control Loop</b> (RTC interrupt driven): </p><div class="fragment"><div class="line">RTC Alarm → heater_on_interupt() → MAX31855 SPI read → store in temperature array</div>
<div class="line">  └► Every PID_CALC_INTERVAL_SECONDS: calculate slope/mean → PID adjustment</div>
</div><!-- fragment --><p><b>User Input Flow</b> (GPIO/TIM interrupt driven): </p><div class="fragment"><div class="line">Button/Encoder → HAL_GPIO_EXTI_Callback() → event_enqueue() → ui_update() → LCD display</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md8"></a>
Heater Control (<span class="tt">heater.c</span>)</h2>
<p>Controls 3 heating coils with 7 power levels (0-6):</p><ul>
<li>Level 0: All OFF</li>
<li>Level 1: Coil1 PWM</li>
<li>Level 2: Coil1 ON</li>
<li>Level 3: Coil1 ON, Coil2 PWM</li>
<li>Level 4: Coil1+2 ON</li>
<li>Level 5: Coil1+2 ON, Coil3 PWM</li>
<li>Level 6: All ON</li>
</ul>
<p>PWM is manual toggle with <span class="tt"><a class="el" href="heater_8h.html#a317b01705a0a50f953afb715b473fd84" title="PWM toggle period in seconds (coil stays on for this duration).">PWM_ON_SECONDS</a></span> (2s) period.</p>
<p>Door safety: Opening door (SW_C) pauses heating; closing resumes previous level.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md9"></a>
UI State Machine (<span class="tt">ui.c</span>)</h2>
<p>Menu structure using <span class="tt"><a class="el" href="ui_8h.html#a6079192a7476e2c9bac0c719a3cfb91a" title="Menu state enumeration for UI state machine.">ui_menupoint_t</a></span> enum: </p><div class="fragment"><div class="line">PROGRAMS ←→ SETPOINT ←→ SETTINGS</div>
<div class="line">    ↓                       ↓</div>
<div class="line">PROGRAMS_OVERVIEW      SETTINGS_OVERVIEW</div>
<div class="line">    ↓</div>
<div class="line">PROGRAM_DETAILED / CREATE_PROGRAM</div>
</div><!-- fragment --><p>Navigation: BUT1/ENC_DOWN=left/down, BUT2/ENC_UP=right/up, BUT3=back, ENC_BUT=enter</p>
<p>Programs define firing profiles with gradient (°C/h) and target temperature sequences.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Event Queue (<span class="tt">event.c</span>)</h2>
<p>Linked-list FIFO queue for decoupling interrupt handlers from UI processing. Events: BUT1-4, ENC_BUT, ENC_UP, ENC_DOWN.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md11"></a>
Hardware Pin Mapping (from <span class="tt">main.h</span>)</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Function  </th><th class="markdownTableHeadNone">Port  </th><th class="markdownTableHeadNone">Pin  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Heater Coil 1  </td><td class="markdownTableBodyNone">PA3  </td><td class="markdownTableBodyNone">SW1  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Heater Coil 2  </td><td class="markdownTableBodyNone">PA4  </td><td class="markdownTableBodyNone">SW2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Heater Coil 3  </td><td class="markdownTableBodyNone">PA5  </td><td class="markdownTableBodyNone">SW3  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Door Switch  </td><td class="markdownTableBodyNone">PB2  </td><td class="markdownTableBodyNone">SW_C  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Encoder A  </td><td class="markdownTableBodyNone">PB4  </td><td class="markdownTableBodyNone">ENC_A  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Encoder B  </td><td class="markdownTableBodyNone">PB3  </td><td class="markdownTableBodyNone">ENC_B  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Encoder Button  </td><td class="markdownTableBodyNone">PA15  </td><td class="markdownTableBodyNone">BUT5  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Buttons 1-4  </td><td class="markdownTableBodyNone">PF7,PF6,PB1,PB0  </td><td class="markdownTableBodyNone">BUT1-4  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SPI2 NSS  </td><td class="markdownTableBodyNone">PB12  </td><td class="markdownTableBodyNone">MAX31855 CS  </td></tr>
</table>
<h1 class="doxsection"><a class="anchor" id="autotoc_md12"></a>
Peripheral Usage</h1>
<ul>
<li><b>I2C1</b>: LCD1602 RGB display (addr 0x7c LCD, 0xc0 RGB controller)</li>
<li><b>SPI2</b>: MAX31855 thermocouple-to-digital converter</li>
<li><b>USART1</b>: Debug logging @ 9600 baud</li>
<li><b>RTC</b>: Periodic alarm for temperature sampling</li>
<li><b>TIM3</b>: Encoder input capture</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md13"></a>
Configuration Constants</h1>
<p>In <span class="tt"><a class="el" href="heater_8h.html" title="Heater control module for kiln heating coils.">heater.h</a></span>:</p><ul>
<li><span class="tt"><a class="el" href="heater_8h.html#a317b01705a0a50f953afb715b473fd84" title="PWM toggle period in seconds (coil stays on for this duration).">PWM_ON_SECONDS</a></span>: 2s PWM toggle period</li>
<li><span class="tt"><a class="el" href="heater_8h.html#a3cb676694bb157591763faaf5df6d11f" title="RTC alarm interval in seconds (must be &lt;= other intervals).">INTERUPT_INTERVAL_SECONDS</a></span>: 1s RTC alarm interval</li>
<li><span class="tt"><a class="el" href="heater_8h.html#a86f31d060a1457c2fca2021fcd696d5b" title="Temperature sampling interval in seconds.">TEMPERATURE_SAMPLING_INTERVAL_SECONDS</a></span>: 1s</li>
<li><span class="tt"><a class="el" href="heater_8h.html#ac83009838eafe965466cfd4113b347b3" title="PID calculation interval in seconds.">PID_CALC_INTERVAL_SECONDS</a></span>: 10s</li>
</ul>
<p>In <span class="tt"><a class="el" href="ui_8h.html" title="User interface module for menu-driven LCD control.">ui.h</a></span>:</p><ul>
<li><span class="tt"><a class="el" href="ui_8h.html#af900a8b6b1e1763dd0e90e48fc2fb317" title="Maximum allowed temperature in degrees C.">MAX_TEMPERATURE</a></span>: 1300°C</li>
<li><span class="tt"><a class="el" href="ui_8h.html#ac8299b112f9f3dd050ea12ac21f89abb" title="Maximum allowed gradient in degrees C per hour (both positive and negative).">MAX_GRADIENT</a></span>: 650°C/h</li>
<li><span class="tt"><a class="el" href="ui_8h.html#ae4f4e755e2b7c93858f0c25a0a3d0169" title="Maximum number of programs that can be stored.">MAX_PROGRAMS</a></span>: 10, <span class="tt"><a class="el" href="ui_8h.html#a5e42b43307bd8b0b0a17827f7d23364c" title="Maximum number of sequences in a program.">MAX_PROGRAM_SEQ_LENGTH</a></span>: 10</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Debug Logging</h1>
<p>Enable/disable per-module logging via defines:</p><ul>
<li><span class="tt"><a class="el" href="heater_8h.html#a425c5a717a6daefdc20039149d22edb2" title="Enable printf logs for heater module.">HEATER_ENABLE_LOG</a></span> in <a class="el" href="heater_8h.html" title="Heater control module for kiln heating coils.">heater.h</a></li>
<li><span class="tt"><a class="el" href="ui_8h.html#a0204450c0520bee3084fe20734d868df" title="Enable debug logging for UI module.">UI_ENABLE_LOG</a></span> in <a class="el" href="ui_8h.html" title="User interface module for menu-driven LCD control.">ui.h</a></li>
<li><span class="tt">EVENT_ENABLE_LOG</span> in <a class="el" href="event_8h.html" title="Event queue module for decoupling interrupt handlers from UI processing.">event.h</a></li>
<li><span class="tt"><a class="el" href="log_8h.html#a3ce0b92ed3b23e6374b1953997164968" title="Threshold for log message filtering.">LOG_LEVEL_THRESHOLD</a></span> in <a class="el" href="log_8h.html" title="Logging module with configurable log levels and UART output.">log.h</a> (0=DEBUG, 3=ERROR only)</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Code Conventions</h1>
<ul>
<li>All modules use HAL-style handle typedefs: <span class="tt">*_HandleTypeDef_t</span></li>
<li>Functions return <span class="tt">HAL_StatusTypeDef</span> (HAL_OK/HAL_ERROR)</li>
<li>CubeMX-generated code between <span class="tt">/* USER CODE BEGIN */</span> and <span class="tt">/* USER CODE END */</span> markers</li>
<li>printf output redirected to UART via <span class="tt"><a class="el" href="log_8h.html#a245a18ca0b0a09ff6e8d2e55ef757315" title="Enable printf rerouting to UART.">REROUTE_PRINTF</a></span> define </li>
</ul>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.16.1 </li>
  </ul>
</div>
</body>
</html>
